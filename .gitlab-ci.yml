image: sinntern/ubuntu_for_django:latest

variables:
  LANG: C.UTF-8
  POSTGRES_DB: landmatrix
  POSTGRES_USER: landmatrix
  POSTGRES_PASSWORD: landmatrix
  STAGING_HOST: dev.landmatrix.org
  STAGING_USER: landmatrix
  PRODUCTION_HOST: landmatrix.org
  PRODUCTION_USER: landmatrix
  DJANGO_SETTINGS_MODULE: config.settings.ci
  DATABASE_URL: "postgis://landmatrix:landmatrix@postgres/landmatrix"

stages:
  - test
  - deploy

django formatting and linting:
  stage: test
  interruptible: true
  script:
    - poetry install
    - black . --check
    # - poetry run pylint config  -d unused-wildcard-import,unused-import,wildcard-import
    # - poetry run pylint apps --exit-zero # pylint is quite broken at the moment

django tests and coverage:
  stage: test
  interruptible: true
  services:
    - name: postgis/postgis:12-3.2
      alias: postgres
  script:
    - poetry install
    - poetry run doit -n 4 update
    - poetry run pytest -x
  coverage: /^TOTAL.*\s+(\d+\%)$/

frontend formatting and linting:
  stage: test
  interruptible: true
  script:
    - cd frontend
    - npm ci
    - npm run lint
    - npm run build

newfront test:
  stage: test
  interruptible: true
  script:
    - cd newfront
    - npm ci
    - npm run test

newfront integration test:
  stage: test
  interruptible: true
  services:
    - name: postgis/postgis:12-3.2
      alias: postgres
  before_script:
    - npm ci && npx playwright install && npx playwright install-deps
    - cd frontend && npm ci
    - poetry install
  script:
    - poetry run doit initial_setup production=True
    - poetry run ./manage.py create_playwright_test_users
    - ./test.sh
  artifacts:
    when: always
    paths:
        - test-results/
        - results.xml
    reports:
        junit: results.xml

newfront formatting and linting:
  stage: test
  interruptible: true
  script:
    - cd newfront
    - npm ci
    - npm run format:check
#   TODO: fix errors
#    - npm run lint
    - npm run build

deploy to staging:
  stage: deploy
  script:
    - eval $(ssh-agent -s)
    - echo "$STAGING_SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - |
      ssh $STAGING_USER@$STAGING_HOST << E=O=F
      set -e
      mv maintenance.html_ maintenance.html || echo "could not move maintenance"
      cd ~/htdocs
      poetry run doit full_update dev=True production=True
      cd newfront/
      npm ci
      npm run build
      sudo /bin/systemctl restart webapp-node-dev.landmatrix.org.service
      sudo /bin/systemctl restart webapp-django-dev.landmatrix.org.service
      cd ~
      mv maintenance.html maintenance.html_
      E=O=F
  only:
    - main

deploy to production:
  stage: deploy
  script:
    - eval $(ssh-agent -s)
    - echo "$PRODUCTION_SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - |
      ssh $PRODUCTION_USER@$PRODUCTION_HOST << E=O=F
      set -e
      mv maintenance.html_ maintenance.html || echo "could not move maintenance"
      cd ~/htdocs
      poetry run doit full_update production=True branch=production
      sudo /bin/systemctl restart django-landmatrix.org.service
      cd ~
      mv maintenance.html maintenance.html_
      E=O=F
  only:
    - production
