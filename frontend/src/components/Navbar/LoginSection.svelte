<script lang="ts">
  import { _ } from "svelte-i18n"

  import { page } from "$app/stores"

  import { UserRole } from "$lib/types/data"
  import { getCsrfToken } from "$lib/utils"

  import NavDropDown from "$components/Navbar/NavDropDown.svelte"

  let user: typeof $page.data.user
  $: user = $page.data.user

  let userRolesMap: { [role in UserRole]: string }
  $: userRolesMap = {
    [UserRole.ANYBODY]: $_("Anybody"),
    [UserRole.REPORTER]: $_("Reporter"),
    [UserRole.EDITOR]: $_("Editor"),
    [UserRole.ADMINISTRATOR]: $_("Administrator"),
  }

  const logout = async () => {
    const ret = await fetch("/api/user/logout/", {
      method: "POST",
      credentials: "include",
      headers: {
        "X-CSRFToken": await getCsrfToken(),
        "Content-Type": "application/json",
      },
    })
    if (ret.ok) location.reload()
    else console.log(await ret.json())
  }
</script>

{#if user}
  <div>
    <NavDropDown placement="right-0">
      <svelte:fragment slot="title">
        <div
          class="heading5 m-2 flex h-10 w-10 items-center justify-center rounded-full bg-pelorous font-bold uppercase text-black md:h-12 md:w-12"
        >
          {user.full_name
            ? user.full_name
                .split(" ")
                .map(x => x[0])
                .join("")
            : user.username.substring(0, 2)}
        </div>
      </svelte:fragment>

      <div class="divide-y divide-solid bg-white shadow-lg dark:bg-gray-900">
        <p class="m-0 whitespace-nowrap p-2 leading-5 text-gray-400">
          {user.full_name}
          <br />
          <small>{userRolesMap[user.role]}</small>
        </p>

        <ul>
          <li>
            <a class="nav-link-secondary" href="/management/">
              {$_("Manage")}
            </a>
          </li>
          <li class="whitespace-nowrap">
            <a class="nav-link-secondary" href="/statistics/">
              {$_("Data Statistics")}
            </a>
          </li>
        </ul>
        <ul>
          <li>
            <a class="nav-link-secondary" href="/deal/add/">{$_("Add a deal")}</a>
          </li>
          <li>
            <a
              class="nav-link-secondary"
              target="_blank"
              href="https://doc.landmatrix.org"
            >
              {$_("Documentation")}
            </a>
          </li>
          <li>
            <button
              type="button"
              class="nav-link-secondary text-left"
              on:click|preventDefault={logout}
            >
              {$_("Logout")}
            </button>
          </li>
        </ul>
      </div>
    </NavDropDown>
  </div>
{:else}
  <div>
    <a
      class="btn btn-primary mx-1 w-fit px-3 py-1 sm:mx-3 sm:px-6 sm:py-2 lg:px-10"
      href="/account/login/?next={$page.url.pathname}"
      title={$_("Login/Register")}
    >
      {$_("Login")}
    </a>
  </div>
{/if}
